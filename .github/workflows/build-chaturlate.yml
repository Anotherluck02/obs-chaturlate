name: Build Chaturlate Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-macos:
    name: Build on macOS
    runs-on: macos-13  # macOS 13 with Xcode 15 (compatible SDK)
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos-build
      
      - name: Install dependencies
        run: |
          brew install cmake ninja
      
      - name: Fix ccache configuration for newer ccache versions
        run: |
          # Comment out run_second_cpp which is not supported in ccache 4.12+
          if [ -f .github/scripts/utils.zsh/setup_ccache ]; then
            sed -i '' 's/ccache --set-config=run_second_cpp=true/# ccache --set-config=run_second_cpp=true  # Disabled for ccache 4.12+/' .github/scripts/utils.zsh/setup_ccache
          fi
      
      - name: Display system info
        run: |
          echo "macOS version:"
          sw_vers
          echo ""
          echo "Xcode version:"
          xcodebuild -version
          echo ""
          echo "CMake version:"
          cmake --version
          echo ""
          echo "SDK Path:"
          xcrun --show-sdk-path
      
      - name: Start build to download dependencies
        continue-on-error: true
        timeout-minutes: 3
        run: |
          # Start the build which will download OBS sources
          # This will likely fail at SDK check, but that's expected
          ./.github/scripts/build-macos -c Release
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
      
      - name: Patch OBS SDK version check
        run: |
          chmod +x .github/scripts/patch-obs-sdk-check.sh
          ./.github/scripts/patch-obs-sdk-check.sh
      
      - name: Build plugin (after patch)
        run: |
          # Build with verbose output to capture linker errors
          ./.github/scripts/build-macos -c Release -v 2>&1 | tee build.log || {
            echo "=== Build failed, checking for errors ==="
            echo ""
            echo "=== Searching for undefined symbols ==="
            grep -A 100 "Undefined symbols" build.log || echo "No 'Undefined symbols' found"
            echo ""
            echo "=== Searching for linker errors ==="
            grep -i "ld:" build.log | tail -50 || echo "No 'ld:' errors found"
            echo ""
            echo "=== Searching for 'error:' ==="
            grep -i "error:" build.log | tail -50 || echo "No 'error:' found"
            echo ""
            echo "=== Last 100 lines of build log ==="
            tail -100 build.log
            exit 1
          }
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
      
      - name: Check build output
        run: |
          echo "=== Build directory contents ==="
          ls -lah build_macos/ || echo "build_macos not found"
          echo ""
          echo "=== Checking for plugin in build directory ==="
          find build_macos -name "*.plugin" -type d 2>/dev/null || echo "No .plugin found in build_macos"
          echo ""
          echo "=== Checking install directory ==="
          if [ -d "release/Release" ]; then
            echo "Release directory found:"
            ls -lah release/Release/
            find release/Release -name "*.plugin" -type d 2>/dev/null || echo "No .plugin in release/Release"
          fi
          echo ""
          echo "=== Checking Xcode build products ==="
          if [ -d "build_macos/Release" ]; then
            echo "Release build directory found:"
            ls -lah build_macos/Release/
            find build_macos/Release -name "*.plugin" -type d 2>/dev/null || echo "No .plugin in build_macos/Release"
          fi
          echo ""
          echo "=== Checking for any .plugin files ==="
          find . -name "*.plugin" -type d 2>/dev/null | head -10 || echo "No .plugin found anywhere"
          echo ""
          echo "=== Checking build log for errors ==="
          if [ -f "build.log" ]; then
            echo "Last 50 lines of build.log:"
            tail -50 build.log
            echo ""
            echo "Checking for linker errors:"
            grep -i "error\|undefined\|failed" build.log | tail -20 || echo "No obvious errors found"
          fi
          echo ""
          # Check if plugin exists in expected location
          if [ -d "build_macos/obs-squawk.plugin" ]; then
            echo "‚úÖ Plugin found in build_macos/obs-squawk.plugin"
            du -sh build_macos/obs-squawk.plugin
            ls -lR build_macos/obs-squawk.plugin/Contents/ | head -20
          elif [ -d "release/Release/obs-squawk.plugin" ]; then
            echo "‚úÖ Plugin found in release/Release/obs-squawk.plugin"
            du -sh release/Release/obs-squawk.plugin
            ls -lR release/Release/obs-squawk.plugin/Contents/ | head -20
          else
            echo "‚ùå Plugin not found in expected locations!"
            echo "Build may have failed during linking or install step."
            exit 1
          fi
      
      - name: Create plugin archive
        run: |
          # Find the plugin location
          if [ -d "build_macos/obs-squawk.plugin" ]; then
            PLUGIN_PATH="build_macos/obs-squawk.plugin"
          elif [ -d "release/Release/obs-squawk.plugin" ]; then
            PLUGIN_PATH="release/Release/obs-squawk.plugin"
          else
            echo "‚ùå Plugin not found for archiving!"
            exit 1
          fi
          
          cd build_macos
          tar -czf obs-squawk-chaturlate-plugin.tar.gz -C .. "${PLUGIN_PATH#../}"
          echo "Archive created:"
          ls -lh obs-squawk-chaturlate-plugin.tar.gz
      
      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: obs-squawk-chaturlate-macos-arm64
          path: build_macos/obs-squawk-chaturlate-plugin.tar.gz
          retention-days: 30
      
      - name: Upload raw plugin bundle
        run: |
          # Find the plugin location
          if [ -d "build_macos/obs-squawk.plugin" ]; then
            PLUGIN_PATH="build_macos/obs-squawk.plugin"
          elif [ -d "release/Release/obs-squawk.plugin" ]; then
            PLUGIN_PATH="release/Release/obs-squawk.plugin"
          else
            echo "‚ùå Plugin not found for upload!"
            exit 1
          fi
          
          # Create a temporary directory with the plugin
          mkdir -p temp-upload
          cp -R "${PLUGIN_PATH}" temp-upload/
          
          # Upload using actions/upload-artifact
          echo "Plugin path: ${PLUGIN_PATH}"
          echo "Uploading plugin bundle..."
        continue-on-error: true
      
      - name: Upload raw plugin bundle (artifact)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: obs-squawk-plugin-bundle
          path: temp-upload/obs-squawk.plugin/
          retention-days: 30
  
  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: build-macos
    
    steps:
      - name: Display installation instructions
        run: |
          cat << 'EOF'
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë          üéâ Chaturlate Plugin Build Successful! üéâ            ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          
          üì¶ INSTALLATION INSTRUCTIONS:
          
          1. Download the artifact from the "Actions" tab above
          2. Extract the tar.gz file:
             tar -xzf obs-squawk-chaturlate-plugin.tar.gz
          
          3. Install the plugin on your Mac:
             mkdir -p ~/Library/Application\ Support/obs-studio/plugins
             cp -r obs-squawk.plugin ~/Library/Application\ Support/obs-studio/plugins/
          
          4. Code sign the plugin (required on macOS):
             codesign --force --deep --sign - ~/Library/Application\ Support/obs-studio/plugins/obs-squawk.plugin
          
          5. Restart OBS Studio
          
          üéØ USAGE:
          
          1. Add your microphone as an audio source in OBS
          2. Right-click the mic ‚Üí Filters ‚Üí Add Filter
          3. Select "Chaturlate (Hold L: STT ‚Üí Translation ‚Üí TTS)"
          4. Configure the filter:
             - Choose Whisper model (for Speech-to-Text)
             - Enable translation if needed
             - Choose TTS model and voice
          5. Go to OBS Settings ‚Üí Hotkeys
          6. Find "Chaturlate - Hold to Translate (L)"
          7. Bind it to the "L" key
          8. Test:
             - Hold L and speak
             - Release L
             - Hear translated speech!
          
          ‚ú® FEATURES:
          - Hold L key to activate
          - Mic auto-mutes when L is pressed
          - Speech-to-Text via Whisper
          - Translation via CTranslate2
          - Text-to-Speech via Sherpa-ONNX
          
          üìù For issues, check the logs in OBS or open an issue on GitHub.
          EOF

